name: Publish to npm

on:
  push:
    branches:
      - main

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Check for version change
        id: check_version
        run: |
          git fetch --tags
          LAST_TAG=$(git describe --tags --abbrev=0)
          echo "Last tag: $LAST_TAG"

          # Check if the package version has changed since the last tag
          if [ -z "$LAST_TAG" ]; then
            echo "No previous version found. This will be published."
            echo "::set-output name=version_changed::true"
          else
            LAST_VERSION=$(echo "$LAST_TAG" | sed 's/^v//')
            CURRENT_VERSION=$(jq -r .version package.json)
            if [ "$CURRENT_VERSION" != "$LAST_VERSION" ]; then
              echo "Version has changed from $LAST_VERSION to $CURRENT_VERSION"
              echo "::set-output name=version_changed::true"
            else
              echo "Version has not changed."
              echo "::set-output name=version_changed::false"
            fi
          fi

      - name: Publish to npm
        if: steps.check_version.outputs.version_changed == 'true'
        uses: pascalgn/npm-publish-action@1.3.9
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_AUTH_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}

      - name: Version published
        if: steps.check_version.outputs.version_changed == 'true'
        run: echo "Package published successfully."
